{"version":3,"file":"processor.js","sources":["../../src/concurrency/processor.ts"],"sourcesContent":["import { Logger, LOG_LEVEL_VERBOSE } from \"../common/logger\";\nimport type { ReactiveSource } from \"../dataobject/reactive\";\nimport { RESULT_TIMED_OUT } from \"../common/const\";\nimport { noop, delay, fireAndForget, promiseWithResolver, PromiseWithResolvers, yieldNextMicrotask } from \"../promises\";\nexport class Notifier {\n\n    _p: PromiseWithResolvers<void> = promiseWithResolver<void>();\n    isUsed = false;\n    notify() {\n        if (!this.isUsed) {\n            return;\n        }\n        this.isUsed = false;\n        this._p.promise.finally(noop)\n        this._p.resolve()\n        this._p = promiseWithResolver();\n    }\n    get nextNotify(): Promise<void> {\n        this.isUsed = true;\n        return this._p.promise;\n    }\n}\nlet processNo = 0;\n\nconst allRunningProcessors = new Set<QueueProcessor<any, any>>([]);\n\n/**\n * QueueProcessor Parameters\n */\ntype ProcessorParams<T> = {\n    /**\n     * How many processes runs concurrently\n     */\n    concurrentLimit?: number;\n    /**\n     * Number of entities passed to the processor at once\n     */\n    batchSize?: number;\n    /**\n     * Numbers of queued entities to ignore delay and run immediately\n     */\n    yieldThreshold?: number;\n    /**\n     * Time(ms) to ignore yieldThreshold and run process\n     */\n    delay?: number;\n    interval?: number;\n    maintainDelay?: boolean;\n    suspended: boolean;\n    /**\n     * ReactiveSource to notify the remaining count.\n     */\n    remainingReactiveSource?: ReactiveSource<number>;\n    /**\n     * ReactiveSource to notify the total remaining count.\n     */\n    totalRemainingReactiveSource?: ReactiveSource<number>;\n    /**\n     * ReactiveSource to notify how many items are processing;\n     */\n    processingEntitiesReactiveSource?: ReactiveSource<number>;\n    /**\n     * If true, processed result will be buffered until a downstream has been connected.\n     */\n    keepResultUntilDownstreamConnected?: boolean;\n    pipeTo?: QueueProcessor<T, any>;\n};\n\ntype ProcessorResult<T> = Promise<T[]> | T[] | undefined | void | Promise<void> | Promise<undefined>;\ntype Processor<T, U> = (entity: T[]) => ProcessorResult<U>\nexport class QueueProcessor<T, U> {\n    _queue: T[] = [];\n    _processor: Processor<T, U>;\n    _enqueueProcessor: (queue: T[], newEntity: T) => T[] = (queue, entity) => (queue.push(entity), queue);\n    _isSuspended = true;\n    _nextProcessNeedsImmediate = false;\n\n    _pipeTo?: QueueProcessor<U, any>;\n\n    _waitId: string = \"\";\n    _root?: QueueProcessor<any, any> = undefined;\n    _instance = processNo++;\n    _remainingReactiveSource?: ReactiveSource<number>;\n    _totalRemainingReactiveSource?: ReactiveSource<number>;\n    _processingEntitiesReactiveSource?: ReactiveSource<number>;\n    _keepResultUntilDownstreamConnected = false;\n    _keptResult = [] as U[];\n\n    _runOnUpdateBatch: () => void = () => { };\n\n    // Parameters\n\n    // How many processes running concurrently\n    concurrentLimit: number = 1;\n\n    // How many entries processed at once\n    batchSize: number = 1;\n\n    // How many entries kept in before the delay\n    yieldThreshold: number = 1;\n\n    // If set, wait for set milliseconds after enqueued\n    // Note: If reached to the batchSize, run immediately\n    delay: number = 0;\n    maintainDelay: boolean;\n    interval: number = 0;\n\n    // This means numbers of the entities which are now processing\n    processingEntities: number = 0;\n\n    // This means numbers of the entries which dequeued from the queue but not processed yet.\n    waitingEntries: number = 0;\n\n    get nowProcessing(): number {\n        return this.processingEntities\n    }\n    get totalNowProcessing(): number {\n        return this.nowProcessing + (this._pipeTo?.totalNowProcessing || 0);\n    }\n\n    get remaining(): number {\n        return this._queue.length + this.processingEntities + this.waitingEntries;\n    }\n    get totalRemaining(): number {\n        return this.remaining + (this._pipeTo?.totalRemaining || 0);\n    }\n    updateStatus(setFunc: () => void): void {\n        setFunc();\n        this._updateReactiveSource();\n    }\n\n    suspend(): QueueProcessor<T, U> {\n        this._isSuspended = true;\n        this._notifier.notify();\n        return this;\n    }\n\n    resume(): this {\n        this._isSuspended = false;\n        this._notifier.notify();\n        this.requestNextFlush();\n        this._run();\n        return this;\n    }\n    resumePipeLine(): this {\n        this._pipeTo?.resumePipeLine();\n        this.resume();\n        return this;\n    }\n    startPipeline(): this {\n        this.root.resumePipeLine();\n        return this;\n    }\n    get root(): QueueProcessor<any, any> {\n        if (this._root === undefined) {\n            return this;\n        }\n        return this._root;\n    }\n\n    _notifier: Notifier = new Notifier();\n\n    constructor(processor: Processor<T, U>, params?: ProcessorParams<U>, items?: T[], enqueueProcessor?: (queue: T[], newEntity: T) => T[]) {\n        this._root = this;\n        this._processor = processor;\n        this.batchSize = params?.batchSize ?? 1;\n        this.yieldThreshold = params?.yieldThreshold ?? params?.batchSize ?? 0;\n        this.concurrentLimit = params?.concurrentLimit ?? 1;\n        this.delay = params?.delay ?? 0;\n        this.maintainDelay = params?.maintainDelay ?? false;\n        this.interval = params?.interval ?? 0;\n        if (params?.keepResultUntilDownstreamConnected) this._keepResultUntilDownstreamConnected = params.keepResultUntilDownstreamConnected;\n        if (params?.remainingReactiveSource) this._remainingReactiveSource = params?.remainingReactiveSource;\n        if (params?.totalRemainingReactiveSource) this._totalRemainingReactiveSource = params?.totalRemainingReactiveSource;\n        if (params?.processingEntitiesReactiveSource) this._processingEntitiesReactiveSource = params?.processingEntitiesReactiveSource;\n        if (params?.suspended !== undefined) this._isSuspended = params?.suspended;\n        if (enqueueProcessor) this.replaceEnqueueProcessor(enqueueProcessor);\n        if (params?.pipeTo !== undefined) {\n            this.pipeTo(params.pipeTo);\n        }\n        if (items) this.enqueueAll(items);\n        allRunningProcessors.add(this);\n        this._run();\n    }\n\n    /**\n     * replace enqueue logic.\n     * @param processor enqueue logic. this should return new queue.\n     * @returns \n     */\n    replaceEnqueueProcessor(processor: (queue: T[], newItem: T) => T[]): this {\n        this._enqueueProcessor = processor;\n        return this;\n    }\n\n    /**\n     * Modify the queue by force. \n     * @param processor \n     * @remarks I know that you have known this is very dangerous.\n     */\n    modifyQueue(processor: (queue: T[]) => T[]): void {\n        this._queue = processor(this._queue);\n        this._notifier.notify();\n    }\n\n    /**\n     * Clear the queue\n     * @remarks I know that you have known this is very dangerous.\n     */\n    clearQueue(): void {\n        this._queue = [];\n        this._notifier.notify();\n    }\n\n    /**\n     * Set the handler for when the queue has been modified\n     * @param proc \n     * @returns \n     */\n    onUpdateProgress(proc: () => void): this {\n        this._runOnUpdateBatch = proc;\n        return this;\n    }\n\n    /**\n     * Join another processor\n     * @param pipeTo \n     * @returns \n     */\n    pipeTo<V>(pipeTo: QueueProcessor<U, V>): QueueProcessor<U, V> {\n        this._pipeTo = pipeTo;\n        this._pipeTo._root = this.root;\n        // If something buffered, send to the downstream.\n        if (this._keptResult.length > 0) {\n            const temp = [...this._keptResult];\n            this._keptResult = [];\n            this._pipeTo.enqueueAll(temp);\n        }\n        return pipeTo;\n    }\n\n    isIdle(): boolean {\n        return this._isIdle() && (!this._pipeTo ? true : this._pipeTo.isIdle());\n    }\n    _isIdle(): boolean {\n        return this.totalRemaining == 0;\n    }\n    async _idleDetector(): Promise<void> {\n        if (this._isSuspended) return Promise.resolve();\n        if (this._isIdle()) return Promise.resolve();\n        do {\n            await Promise.race([delay(3000), this._notifier.nextNotify]);\n        } while (!this._isIdle());\n        return Promise.resolve();\n    }\n\n    idleDetectors(): Promise<void>[] {\n        const thisPromise = this._idleDetector();\n        if (this._pipeTo) {\n            return [thisPromise, ...this._pipeTo.idleDetectors()];\n        }\n        return [thisPromise];\n    }\n\n    get isSuspended(): boolean {\n        return this._isSuspended || this._pipeTo?.isSuspended || false;\n    }\n\n\n    _updateReactiveSource(): void {\n        this.root.updateReactiveSource();\n    }\n    updateReactiveSource(): void {\n        if (this._pipeTo) {\n            this._pipeTo.updateReactiveSource();\n        }\n        if (this._remainingReactiveSource) this._remainingReactiveSource.value = this.remaining;\n        if (this._totalRemainingReactiveSource) this._totalRemainingReactiveSource.value = this.totalRemaining;\n        if (this._processingEntitiesReactiveSource) this._processingEntitiesReactiveSource.value = this.nowProcessing;\n\n    }\n    _updateBatchProcessStatus(): void {\n        this._updateReactiveSource();\n        this._runOnUpdateBatch();\n    }\n\n    _collectBatch(): T[] {\n        return this._queue.splice(0, this.batchSize);\n    }\n    _canCollectBatch(): boolean {\n        return this._queue.length !== 0;\n    }\n\n\n    enqueue(entity: T): this {\n        this._queue = this._enqueueProcessor(this._queue, entity);\n        this._updateBatchProcessStatus()\n        this._notifier.notify();\n        return this;\n    }\n    enqueueAll(entities: T[]): this {\n        let queue = this._queue;\n        for (const v of entities) {\n            queue = this._enqueueProcessor(queue, v);\n        }\n        this._queue = queue;\n        this._updateBatchProcessStatus()\n        this._notifier.notify();\n        return this;\n    }\n\n    requestNextFlush(): void {\n        if (this._canCollectBatch()) {\n            this._nextProcessNeedsImmediate = true;\n            this._notifier.notify();\n        }\n    }\n\n    flush(): Promise<boolean> | undefined {\n        if (this._isSuspended) return;\n        this.requestNextFlush();\n        return this.waitForAllDownstream();\n    }\n\n    async waitForAllDownstream(timeout?: number): Promise<boolean> {\n        // Prepare timeout detector\n        const baseTasks = [] as Promise<unknown>[];\n        if (timeout) {\n            baseTasks.push(delay(timeout, RESULT_TIMED_OUT))\n        }\n        do {\n            const idleTasks = this.idleDetectors();\n            const tasks = [...baseTasks, Promise.all(idleTasks)];\n            const ret = await Promise.race(tasks);\n            if (ret === RESULT_TIMED_OUT) return false;\n        } while (!this.isIdle());\n        return true;\n    }\n\n    waitForAllProcessed(timeout?: number): Promise<boolean> {\n        this.root.startPipeline();\n        return this.root.waitForAllDownstream(timeout);\n    }\n    async waitForAllDoneAndTerminate(timeout?: number): Promise<boolean> {\n        this.root.startPipeline();\n        const r = await this.root.waitForAllDownstream(timeout);\n        this.terminateAll();\n        return r;\n    }\n    async _runProcessor(items: T[]): Promise<void> {\n        // runProcessor does not modify queue. so updateStatus should only update about reactiveSource.\n        const ret = await this._processor(items);\n        if (!ret) return;\n        // If downstream is connected, the result sent to that.\n        if (this._pipeTo) {\n            this._pipeTo.enqueueAll(ret);\n        } else if (this._keepResultUntilDownstreamConnected) {\n            // Buffer the result if downstream is not connected.\n            this._keptResult.push(...ret);\n        }\n    }\n    async * pump(): AsyncGenerator<T[], void, unknown> {\n        let items: T[];\n        let queueRunOut = true;\n        do {\n            await yieldNextMicrotask();\n            if (!this._canCollectBatch()) {\n                // If we cannot collect any items from the queue, sleep until a next notify\n                queueRunOut = true;\n                await Promise.race([this._notifier.nextNotify, delay(3000)]);\n                continue;\n            }\n            // Here, we have some items in the queue.\n            if (queueRunOut) {\n                // If the pump has been slept, wait for the chance to accumulate some more in the queue.\n                await this.delayUntilRequested(this.delay);\n            }\n            items = this._collectBatch();\n            // If the queue has been modified (by modifyQueue or something).\n            // We have to try from the begin again.\n            if (items.length == 0) {\n                continue;\n            }\n            yield items;\n            // For subsequent processes, check run out status\n            if (this._canCollectBatch()) {\n                queueRunOut = false;\n            }\n        } while (this._canCollectBatch() && !this._isSuspended)\n    }\n    _processingBatches: Set<number> = new Set<number>();\n    addProcessingBatch: (typeof this._processingBatches.add) = (value) => {\n        const r = this._processingBatches.add(value);\n        this._updateBatchProcessStatus();\n        return r;\n    }\n    deleteProcessingBatch: (typeof this._processingBatches.delete) = (value) => {\n        const r = this._processingBatches.delete(value);\n        this._updateBatchProcessStatus();\n        return r;\n    }\n    _processing: boolean = false;\n\n    async delayUntilRequested(delayMs: number): Promise<void> {\n        if (this._nextProcessNeedsImmediate) {\n            this._nextProcessNeedsImmediate = false;\n            return;\n        }\n        const delayTimer = delay(delayMs, RESULT_TIMED_OUT);\n        let ret;\n        do {\n            ret = await Promise.race([this._notifier.nextNotify, delayTimer]);\n        } while (\n            ret !== RESULT_TIMED_OUT &&\n            this._nextProcessNeedsImmediate === false &&\n            this.yieldThreshold >= this._queue.length\n        )\n        this._nextProcessNeedsImmediate = false;\n        return;\n    }\n\n    async _process(): Promise<void> {\n        if (this._processing && this._isSuspended) return;\n        let lastProcessBegin = 0;\n        try {\n            this._processing = true;\n            do {\n                const batchPump = this.pump()\n                for await (const batch of batchPump) {\n                    const batchLength = batch.length;\n                    this.updateStatus(() => {\n                        this.waitingEntries += batchLength;\n                    })\n                    while (this._processingBatches.size >= this.concurrentLimit) {\n                        await this._notifier.nextNotify;\n                    }\n                    // Add batch to the processing\n                    const key = Date.now() + Math.random();\n                    const batchTask = async () => {\n                        this.updateStatus(() => {\n                            // To avoid false positive of idle, add processingEntities before reducing waitingEntries\n                            this.processingEntities += batchLength;\n                            this.waitingEntries -= batchLength;\n                        });\n                        this.addProcessingBatch(key);\n                        try {\n                            if (this.interval && lastProcessBegin) {\n                                const diff = Date.now() - lastProcessBegin;\n                                if (diff < this.interval) {\n                                    const delayMs = this.interval - diff;\n                                    await delay(delayMs);\n                                }\n                            }\n                            lastProcessBegin = Date.now();\n                            await this._runProcessor(batch);\n                        } catch (ex) {\n                            Logger(`Processor error!`);\n                            Logger(ex, LOG_LEVEL_VERBOSE);\n                        } finally {\n                            this.deleteProcessingBatch(key);\n                            this.updateStatus(() => {\n                                this.processingEntities -= batchLength;\n                            });\n                            this._notifier.notify();\n                        }\n                    }\n\n                    this._notifier.notify();\n                    fireAndForget(async () => {\n                        await yieldNextMicrotask();\n                        await batchTask()\n                    });\n                }\n                await this._notifier.nextNotify;\n            } while (!this._isSuspended)\n        } finally {\n            this._processing = false;\n        }\n    }\n\n    _run(): void {\n        if (this._isSuspended) return;\n        if (this._processing) return;\n        fireAndForget(() => this._process());\n    }\n    terminateAll(): void {\n        this.root.terminate();\n    }\n    terminate(): void {\n        if (this._pipeTo) {\n            this._pipeTo.terminate();\n            this._pipeTo = undefined;\n        }\n        this._isSuspended = true;\n        this._enqueueProcessor = () => [];\n        this._processor = () => Promise.resolve([]);\n        this.clearQueue();\n        this._notifier.notify();\n        this._notifier.notify();\n        this._notifier.notify();\n        this._queue.length = 0;\n        allRunningProcessors.delete(this);\n    }\n}\n\nexport function stopAllRunningProcessors(): void {\n    const processors = [...allRunningProcessors];\n    for (const processor of processors) {\n        processor.terminate();\n    }\n}"],"names":[],"mappings":"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"}