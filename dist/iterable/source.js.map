{"version":3,"file":"source.js","sources":["../../src/iterable/source.ts"],"sourcesContent":["import { promiseWithResolver } from \"../promises\";\n\nconst GENERATOR_CLOSED = Symbol(\"closed\");\nexport function generativeBuffer<T>() {\n    let current = promiseWithResolver<T | typeof GENERATOR_CLOSED>();\n    let next = [current];\n    let closed = false;\n    let finished = false;\n    let onSizeUpdated: ((size: number) => void) | undefined;\n    const updateSize = () => {\n        if (onSizeUpdated) {\n            try { onSizeUpdated(next.length - 1); }\n            catch (_) { }\n        }\n    };\n    return {\n        enqueue(item: T) {\n            if (closed || finished) {\n                throw new Error(\"Cannot enqueue to a closed or finished source\");\n            }\n            const promise = current;\n            const newNext = promiseWithResolver<T | typeof GENERATOR_CLOSED>();\n            current = newNext;\n            next.push(current);\n            updateSize();\n            promise.resolve(item);\n        },\n        [Symbol.asyncIterator](): AsyncGenerator<Awaited<T>, void, unknown> {\n            return this.values();\n        },\n        dispose() {\n            if (closed) return;\n            closed = true;\n            current.resolve(GENERATOR_CLOSED);\n        },\n        finish() {\n            finished = true;\n            current.resolve(GENERATOR_CLOSED);\n        },\n        [Symbol.dispose]() {\n            this.dispose();\n        },\n        async *values(): AsyncGenerator<Awaited<T>, void, unknown> {\n            while (!closed) {\n                try {\n                    const ret = await next[0].promise;\n                    next = next.slice(1); //// Drop the resolved promise\n                    if (ret === GENERATOR_CLOSED) return;\n                    yield ret;\n                } catch (e) {\n                    if (closed || e === GENERATOR_CLOSED) {\n                        return;\n                    }\n                    throw e;\n                } finally {\n                    updateSize();\n                }\n            }\n            try {\n                next.forEach(p => p.reject(GENERATOR_CLOSED));\n                next.length = 0;\n            } catch (e) {\n                console.log(`Error on cleanup: ${String(e)}`);\n            }\n        },\n        get size() {\n            return next.length - 1;\n        }\n    };\n}\n\n\nexport class GeneratorSource<T> {\n    _next: ReturnType<typeof promiseWithResolver<T | typeof GENERATOR_CLOSED>>[];\n    _current: ReturnType<typeof promiseWithResolver<T | typeof GENERATOR_CLOSED>>;\n    _onSizeUpdated?: (size: number) => void;\n    _updateSize() {\n        if (this._onSizeUpdated) {\n            try { this._onSizeUpdated(this.size); }\n            catch (_) { }\n        }\n    }\n    get size() {\n        return this._next.length - 1;\n    }\n    closed: boolean;\n    finished: boolean;\n    constructor(onSizeUpdated?: (size: number) => void) {\n        this.closed = false;\n        this.finished = false;\n        this._current = promiseWithResolver<T | typeof GENERATOR_CLOSED>();\n        this._next = [this._current];\n        this._onSizeUpdated = onSizeUpdated;\n    }\n    enqueue(item: T) {\n        if (this.closed || this.finished) {\n            throw new Error(\"Cannot enqueue to a closed or finished source\");\n        }\n        const promise = this._current;\n        const next = promiseWithResolver<T | typeof GENERATOR_CLOSED>();\n        this._current = next;\n        this._next.push(this._current);\n        this._updateSize();\n        promise.resolve(item);\n    }\n    dispose() {\n        if (this.closed) return;\n        this.closed = true;\n        this._current.resolve(GENERATOR_CLOSED);\n    }\n    finish() {\n        this.finished = true;\n        this._current.resolve(GENERATOR_CLOSED);\n    }\n    [Symbol.asyncIterator]() {\n        return this.values();\n    }\n    [Symbol.dispose]() {\n        console.log(\"@disposed\");\n        this.dispose();\n    }\n    async *values() {\n        while (!this.closed) {\n            try {\n                const ret = await this._next[0].promise;\n                this._next = this._next.slice(1); //// Drop the resolved promise\n                if (ret === GENERATOR_CLOSED) break;\n                yield ret;\n            } catch (e) {\n                if (this.closed || e === GENERATOR_CLOSED) {\n                    break;\n                }\n                throw e;\n            } finally {\n                this._updateSize();\n            }\n        }\n        try {\n            this._next.forEach(p => {\n                p.reject();\n            });\n            this._next.length = 0;\n        } catch (e) {\n            console.log(`Error on cleanup: ${String(e)}`);\n        }\n    }\n}\n\n"],"names":[],"mappings":";;AAEA,MAAM,gBAAgB,GAAG,MAAM,CAAC,QAAQ,CAAC;SACzB,gBAAgB,GAAA;AAC5B,IAAA,IAAI,OAAO,GAAG,mBAAmB,EAA+B;AAChE,IAAA,IAAI,IAAI,GAAG,CAAC,OAAO,CAAC;IACpB,IAAI,MAAM,GAAG,KAAK;IAClB,IAAI,QAAQ,GAAG,KAAK;IAQpB,OAAO;AACH,QAAA,OAAO,CAAC,IAAO,EAAA;AACX,YAAA,IAAI,MAAM,IAAI,QAAQ,EAAE;AACpB,gBAAA,MAAM,IAAI,KAAK,CAAC,+CAA+C,CAAC;;YAEpE,MAAM,OAAO,GAAG,OAAO;AACvB,YAAA,MAAM,OAAO,GAAG,mBAAmB,EAA+B;YAClE,OAAO,GAAG,OAAO;AACjB,YAAA,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC;AAElB,YAAA,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC;SACxB;QACD,CAAC,MAAM,CAAC,aAAa,CAAC,GAAA;AAClB,YAAA,OAAO,IAAI,CAAC,MAAM,EAAE;SACvB;QACD,OAAO,GAAA;AACH,YAAA,IAAI,MAAM;gBAAE;YACZ,MAAM,GAAG,IAAI;AACb,YAAA,OAAO,CAAC,OAAO,CAAC,gBAAgB,CAAC;SACpC;QACD,MAAM,GAAA;YACF,QAAQ,GAAG,IAAI;AACf,YAAA,OAAO,CAAC,OAAO,CAAC,gBAAgB,CAAC;SACpC;QACD,CAAC,MAAM,CAAC,OAAO,CAAC,GAAA;YACZ,IAAI,CAAC,OAAO,EAAE;SACjB;QACD,OAAO,MAAM,GAAA;YACT,OAAO,CAAC,MAAM,EAAE;AACZ,gBAAA,IAAI;oBACA,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,CAAC,CAAC,CAAC,OAAO;oBACjC,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;oBACrB,IAAI,GAAG,KAAK,gBAAgB;wBAAE;AAC9B,oBAAA,MAAM,GAAG;;gBACX,OAAO,CAAC,EAAE;AACR,oBAAA,IAAI,MAAM,IAAI,CAAC,KAAK,gBAAgB,EAAE;wBAClC;;AAEJ,oBAAA,MAAM,CAAC;;wBACD;;;AAId,YAAA,IAAI;AACA,gBAAA,IAAI,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,gBAAgB,CAAC,CAAC;AAC7C,gBAAA,IAAI,CAAC,MAAM,GAAG,CAAC;;YACjB,OAAO,CAAC,EAAE;gBACR,OAAO,CAAC,GAAG,CAAC,CAAqB,kBAAA,EAAA,MAAM,CAAC,CAAC,CAAC,CAAE,CAAA,CAAC;;SAEpD;AACD,QAAA,IAAI,IAAI,GAAA;AACJ,YAAA,OAAO,IAAI,CAAC,MAAM,GAAG,CAAC;;KAE7B;AACL;MAGa,eAAe,CAAA;IAIxB,WAAW,GAAA;AACP,QAAA,IAAI,IAAI,CAAC,cAAc,EAAE;AACrB,YAAA,IAAI;AAAE,gBAAA,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC;;AACpC,YAAA,OAAO,CAAC,EAAE;;;AAGlB,IAAA,IAAI,IAAI,GAAA;AACJ,QAAA,OAAO,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC;;AAIhC,IAAA,WAAA,CAAY,aAAsC,EAAA;AAdlD,QAAA,MAAA,CAAA,cAAA,CAAA,IAAA,EAAA,OAAA,EAAA;;;;;AAA6E,SAAA,CAAA;AAC7E,QAAA,MAAA,CAAA,cAAA,CAAA,IAAA,EAAA,UAAA,EAAA;;;;;AAA8E,SAAA,CAAA;AAC9E,QAAA,MAAA,CAAA,cAAA,CAAA,IAAA,EAAA,gBAAA,EAAA;;;;;AAAwC,SAAA,CAAA;AAUxC,QAAA,MAAA,CAAA,cAAA,CAAA,IAAA,EAAA,QAAA,EAAA;;;;;AAAgB,SAAA,CAAA;AAChB,QAAA,MAAA,CAAA,cAAA,CAAA,IAAA,EAAA,UAAA,EAAA;;;;;AAAkB,SAAA,CAAA;AAEd,QAAA,IAAI,CAAC,MAAM,GAAG,KAAK;AACnB,QAAA,IAAI,CAAC,QAAQ,GAAG,KAAK;AACrB,QAAA,IAAI,CAAC,QAAQ,GAAG,mBAAmB,EAA+B;QAClE,IAAI,CAAC,KAAK,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC;AAC5B,QAAA,IAAI,CAAC,cAAc,GAAG,aAAa;;AAEvC,IAAA,OAAO,CAAC,IAAO,EAAA;QACX,IAAI,IAAI,CAAC,MAAM,IAAI,IAAI,CAAC,QAAQ,EAAE;AAC9B,YAAA,MAAM,IAAI,KAAK,CAAC,+CAA+C,CAAC;;AAEpE,QAAA,MAAM,OAAO,GAAG,IAAI,CAAC,QAAQ;AAC7B,QAAA,MAAM,IAAI,GAAG,mBAAmB,EAA+B;AAC/D,QAAA,IAAI,CAAC,QAAQ,GAAG,IAAI;QACpB,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC;QAC9B,IAAI,CAAC,WAAW,EAAE;AAClB,QAAA,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC;;IAEzB,OAAO,GAAA;QACH,IAAI,IAAI,CAAC,MAAM;YAAE;AACjB,QAAA,IAAI,CAAC,MAAM,GAAG,IAAI;AAClB,QAAA,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,gBAAgB,CAAC;;IAE3C,MAAM,GAAA;AACF,QAAA,IAAI,CAAC,QAAQ,GAAG,IAAI;AACpB,QAAA,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,gBAAgB,CAAC;;IAE3C,CAAC,MAAM,CAAC,aAAa,CAAC,GAAA;AAClB,QAAA,OAAO,IAAI,CAAC,MAAM,EAAE;;IAExB,CAAC,MAAM,CAAC,OAAO,CAAC,GAAA;AACZ,QAAA,OAAO,CAAC,GAAG,CAAC,WAAW,CAAC;QACxB,IAAI,CAAC,OAAO,EAAE;;IAElB,OAAO,MAAM,GAAA;AACT,QAAA,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE;AACjB,YAAA,IAAI;gBACA,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO;AACvC,gBAAA,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;gBACjC,IAAI,GAAG,KAAK,gBAAgB;oBAAE;AAC9B,gBAAA,MAAM,GAAG;;YACX,OAAO,CAAC,EAAE;gBACR,IAAI,IAAI,CAAC,MAAM,IAAI,CAAC,KAAK,gBAAgB,EAAE;oBACvC;;AAEJ,gBAAA,MAAM,CAAC;;oBACD;gBACN,IAAI,CAAC,WAAW,EAAE;;;AAG1B,QAAA,IAAI;AACA,YAAA,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,IAAG;gBACnB,CAAC,CAAC,MAAM,EAAE;AACd,aAAC,CAAC;AACF,YAAA,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC;;QACvB,OAAO,CAAC,EAAE;YACR,OAAO,CAAC,GAAG,CAAC,CAAqB,kBAAA,EAAA,MAAM,CAAC,CAAC,CAAC,CAAE,CAAA,CAAC;;;AAGxD;;;;"}