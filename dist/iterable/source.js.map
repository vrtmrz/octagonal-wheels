{"version":3,"file":"source.js","sources":["../../src/iterable/source.ts"],"sourcesContent":["import { promiseWithResolver } from \"../promises\";\n\nconst GENERATOR_CLOSED = Symbol(\"closed\");\nexport function generativeBuffer<T>() {\n    let current = promiseWithResolver<T | typeof GENERATOR_CLOSED>();\n    let next = [current];\n    let closed = false;\n    let finished = false;\n\n    return {\n        enqueue(item: T) {\n            if (closed || finished) {\n                throw new Error(\"Cannot enqueue to a closed or finished source\");\n            }\n            const promise = current;\n            const newNext = promiseWithResolver<T | typeof GENERATOR_CLOSED>();\n            current = newNext;\n            next.push(current);\n            promise.resolve(item);\n        },\n        [Symbol.asyncIterator](): AsyncGenerator<Awaited<T>, void, unknown> {\n            return this.values();\n        },\n        dispose() {\n            if (closed) return;\n            closed = true;\n            current.resolve(GENERATOR_CLOSED);\n        },\n        finish() {\n            finished = true;\n            current.resolve(GENERATOR_CLOSED);\n        },\n        [Symbol.dispose]() {\n            this.dispose();\n        },\n        async *values(): AsyncGenerator<Awaited<T>, void, unknown> {\n            while (!closed) {\n                try {\n                    const ret = await next[0].promise;\n                    next = next.slice(1); //// Drop the resolved promise\n                    if (ret === GENERATOR_CLOSED) return;\n                    yield ret;\n                } catch (e) {\n                    if (closed || e === GENERATOR_CLOSED) {\n                        return;\n                    }\n                    throw e;\n                }\n            }\n            try {\n                next.forEach(p => p.reject(GENERATOR_CLOSED));\n                next.length = 0;\n            } catch (e) {\n                console.log(`Error on cleanup: ${String(e)}`);\n            }\n        }\n    };\n}\n\n\nexport class GeneratorSource<T> {\n\n    next: ReturnType<typeof promiseWithResolver<T | typeof GENERATOR_CLOSED>>[];\n    current: ReturnType<typeof promiseWithResolver<T | typeof GENERATOR_CLOSED>>;\n    closed: boolean;\n    finished: boolean;\n    constructor() {\n        this.closed = false;\n        this.finished = false;\n        this.current = promiseWithResolver<T | typeof GENERATOR_CLOSED>();\n        this.next = [this.current];\n    }\n    enqueue(item: T) {\n        if (this.closed || this.finished) {\n            throw new Error(\"Cannot enqueue to a closed or finished source\");\n        }\n        const promise = this.current;\n        const next = promiseWithResolver<T | typeof GENERATOR_CLOSED>();\n        this.current = next;\n        this.next.push(this.current);\n        promise.resolve(item);\n    }\n    dispose() {\n        if (this.closed) return;\n        this.closed = true;\n        // this.closedPromise.resolve(GENERATOR_CLOSED);\n        this.current.resolve(GENERATOR_CLOSED);\n    }\n    finish() {\n        this.finished = true;\n        this.current.resolve(GENERATOR_CLOSED);\n    }\n    [Symbol.asyncIterator]() {\n        return this.values();\n    }\n    [Symbol.dispose]() {\n        console.log(\"@disposed\");\n        this.dispose();\n    }\n    async *values() {\n        while (!this.closed) {\n            try {\n                const ret = await this.next[0].promise;\n                this.next = this.next.slice(1); //// Drop the resolved promise\n                if (ret === GENERATOR_CLOSED) break;\n                yield ret;\n            } catch (e) {\n                if (this.closed || e === GENERATOR_CLOSED) {\n                    break;\n                }\n                throw e;\n            }\n        }\n        try {\n            this.next.forEach(p => {\n                p.reject();\n            });\n            this.next.length = 0;\n        } catch (e) {\n            console.log(`Error on cleanup: ${String(e)}`);\n        }\n    }\n}\n\n"],"names":[],"mappings":"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"}